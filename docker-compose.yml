services:
  sheets-sync:
    image: node:18-alpine
    container_name: sheets-sync
    working_dir: /app
    volumes:
      - ./:/app
      - ${OUTPUT_DIR}:/app/output
      - node_modules:/app/node_modules
    environment:
      - NODE_ENV=production
      - SYNC_EVERY_MINUTES=${SYNC_EVERY_MINUTES:-15}
      - OUTPUT_DIR=/app/output
      - OUTPUT_FILE_NAME=${OUTPUT_FILE_NAME:-datos_excel.xlsx}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "console.log('Health check OK')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    command: >
      sh -c "
        echo 'ğŸš€ Iniciando Google Sheets Sync Container...' &&
        echo 'ğŸ“¦ Instalando/verificando dependencias...' &&
        npm ci --only=production &&
        echo 'âœ… Dependencias instaladas' &&
        echo 'ğŸ“ Creando directorios necesarios...' &&
        mkdir -p /app/output &&
        echo 'â° Iniciando scheduler (intervalo: $${SYNC_EVERY_MINUTES} minutos)...' &&
        node src/scheduler.js
      "

volumes:
  node_modules: